<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'/>
    <title>K.C.M ULTIMATE - M1/M15 ULTRA FILTER</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --bg: #06090c; --green: #00ff88; --red: #ff3355; --panel: #11151c; --blue: #00a2ff; --yellow: #ffcc00; --purple: #a020f0; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; }
        .ui { position: absolute; z-index: 1000; width: 100%; pointer-events: none; }
        .interactive { pointer-events: auto; }
        #finance-panel { position: absolute; bottom: 65px; left: 20px; background: rgba(17, 21, 28, 0.95); padding: 12px; border-radius: 8px; border: 1px solid var(--blue); font-size: 13px; z-index: 1000; pointer-events: auto; display: flex; flex-direction: column; gap: 6px; min-width: 180px; }
        .fin-item { display: flex; justify-content: space-between; cursor: pointer; border-bottom: 1px solid #2d3648; padding: 4px 0; }
        .fin-value { color: var(--green); font-weight: bold; margin-left: 15px; }
        .watermark { position: absolute; bottom: 20px; left: 20px; font-size: 18px; font-weight: bold; color: var(--blue); text-shadow: 0 0 10px #fff, 0 0 20px var(--blue); z-index: 500; pointer-events: none; border: 1px solid rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 5px; background: rgba(0,0,0,0.3); }
        .asset-btn { position: absolute; top: 15px; left: 15px; background: var(--panel); padding: 12px 18px; border-radius: 8px; border: 1px solid #2d3648; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: bold; width: 240px; box-sizing: border-box; }
        .asset-menu { display: none; position: absolute; top: 70px; left: 15px; background: var(--panel); border: 1px solid #2d3648; border-radius: 8px; width: 280px; max-height: 70vh; overflow-y: auto; z-index: 1001; }
        .asset-menu.open { display: block; }
        .item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #1c232e; font-size: 13px; }
        .item:hover { background: #1c232e; color: var(--blue); }
        #timer-box { position: absolute; right: 15px; top: 3px; background: rgba(17, 21, 28, 0.95); padding: 10px; border-radius: 8px 8px 0 0; border: 2px solid var(--blue); text-align: center; width: 50px; z-index: 1001; }
        #stopwatch-box { position: absolute; right: 15px; top: 59px; background: rgba(17, 21, 28, 0.95); padding: 10px; border-radius: 0 0 8px 8px; border: 2px solid var(--green); border-top: none; text-align: center; cursor: pointer; user-select: none; width: 50px; z-index: 1001; }
        #placar { position: absolute; top: 115px; left: 15px; background: rgba(17,21,28,0.85); padding: 10px; border-radius: 8px; font-size: 13px; border: 1px solid #333; display: flex; gap: 15px; }
        #trend-info { position: absolute; top: 75px; left: 15px; background: rgba(17, 21, 28, 0.8); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; width: 240px; border-left: 4px solid var(--blue); }
        #signal-alert { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 55px; font-weight: bold; text-shadow: 0 0 20px #000; z-index: 2000; pointer-events: none; display: none; text-align: center; }
        #price-tag { position: absolute; right: 0; padding: 6px 12px; font-family: monospace; font-weight: bold; font-size: 16px; border-radius: 6px 0 0 6px; z-index: 100; color: #000; pointer-events: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #btn-hist { position: absolute; bottom: 80px; right: 20px; background: var(--panel); border: 1px solid var(--blue); color: #fff; padding: 10px 10px; border-radius: 8px; cursor: pointer; z-index: 1000; }
        #modal-hist { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border: 2px solid var(--blue); padding: 20px; border-radius: 12px; z-index: 3000; width: 340px; max-height: 85vh; overflow-y: auto; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        .hist-line { border-bottom: 1px solid #333; padding: 8px 0; font-size: 12px; display: flex; justify-content: space-between; }
        .close-hist { float: right; cursor: pointer; color: var(--red); font-weight: bold; }
        .pdf-btn { width: 100%; margin-top: 15px; background: var(--green); color: #000; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #detailed-log { margin-top: 15px; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 5px; max-height: 200px; overflow-y: auto; border: 1px solid #2d3648; }
        .log-entry { font-family: monospace; font-size: 10px; padding: 4px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<script>
    (function() {
        const SENHA_MESTRE = "1979";
        let acesso = sessionStorage.getItem("kcm_auth");
        if (acesso !== "true") {
            let entrada = prompt("üîí ACESSO RESTRITO - K.C.M ULTIMATE\n\nDigite a senha para liberar o sistema:");
            if (entrada === SENHA_MESTRE) {
                sessionStorage.setItem("kcm_auth", "true");
            } else {
                alert("Senha incorreta!");
                document.body.innerHTML = "<div style='background:#06090c; height:100vh; display:flex; align-items:center; justify-content:center; color:white; font-family:sans-serif;'><h1>Acesso Negado ‚ùå</h1></div>";
                window.location.reload();
                throw new Error("Acesso negado");
            }
        }
    })();
</script>

<div id="signal-alert"></div>
<div id="finance-panel">
    <div class="fin-item" ondblclick="editFinance('banca')">BANCA: <span class="fin-value" id="val-banca">R$ 1000.00</span></div>
    <div class="fin-item" ondblclick="editFinance('payout')">PAYOUT: <span class="fin-value" id="val-payout">85%</span></div>
    <div class="fin-item" ondblclick="editFinance('percent')">ENTRADA: <span class="fin-value" id="val-percent">1%</span></div>
</div>
<div class="watermark">K.COM BRAIN„ÄΩÔ∏è(Aridelson B.)</div>
<div class="ui">
    <div class="asset-btn interactive" onclick="toggleMenu()">
        <span id="asset-display">üìä Volatility 100</span> <small>‚ñº</small>
    </div>
    <div class="asset-menu interactive" id="menu"></div>
    <div id="trend-info" class="interactive">ANALISANDO MERCADO...</div>
    <div id="stopwatch-box" class="interactive" onclick="toggleStopwatch()" ondblclick="resetStopwatch()">
        <span style="font-size:9px">Tempo<br></span><b id="stopwatch">00:00</b>
    </div>
    <div id="timer-box"><span style="font-size:9px">Vela M1<br></span><b id="timer">00:00</b></div>
    <div id="placar" class="interactive">
        <div style="color:var(--green)">WIN: <b id="win-c">0</b></div>
        <div style="color:var(--red)">LOSS: <b id="loss-c">0</b></div>
        <div id="gale-txt" style="color:var(--blue); font-weight: bold;">AGUARDANDO PADR√ÉO</div>
    </div>
</div>

<button id="btn-hist" class="interactive" onclick="toggleHist()">üìã RELAT√ìRIO</button>
<div id="modal-hist">
    <span class="close-hist" onclick="toggleHist()">X</span>
    <center>
        <div style="color:var(--blue); font-weight:bold; font-size:16px;">K.COM BRAIN„ÄΩÔ∏è</div>
        <small style="opacity:0.6; font-size:10px;">RELAT√ìRIO PROFISSIONAL</small>
    </center>
    <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
    <div id="hist-content"></div>
    <div style="font-size: 11px; color: var(--blue); margin-top: 15px; font-weight: bold;">DETALHES DAS ENTRADAS:</div>
    <div id="detailed-log"></div>
    <button class="pdf-btn" onclick="downloadPDF()">BAIXAR PDF</button>
</div>

<canvas id="chartCanvas"></canvas>
<div id="price-tag">0.0000</div>

<script>
    const audioWin = new Audio('https://www.myinstants.com/media/sounds/applause_8.mp3');
    const audioQuaQua = new Audio('https://www.myinstants.com/media/sounds/sad-trompete.mp3'); 
    const audioSirene = new Audio('https://www.myinstants.com/media/sounds/siren.mp3'); 
    
    let stats = {
        bancaInicial: 1000.00,
        startTime: new Date().toLocaleTimeString(),
        totalEntradas: 0,
        winsDireto: 0,
        gale1: 0,
        gale2: 0,
        ativosLucro: {},
        ativoAtual: "Volatility 100",
        fullLog: [] 
    };

    function addDetailedLog(acao, status, cor) {
        const logContainer = document.getElementById('detailed-log');
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0') + ":" + now.getSeconds().toString().padStart(2,'0');
        stats.fullLog.push({ time: timeStr, asset: stats.ativoAtual, action: acao, status: status });
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span>${timeStr} [${stats.ativoAtual}] - ${acao}</span><b style="color:${cor}">${status}</b>`;
        logContainer.prepend(div);
    }

    function falar(texto) {
        const msg = new SpeechSynthesisUtterance(texto);
        msg.lang = 'pt-BR';
        window.speechSynthesis.speak(msg);
    }

    function toggleHist() {
        const m = document.getElementById('modal-hist');
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
        if(m.style.display === 'block') updateHistUI();
    }

    function updateHistUI() {
        const profit = bancaAtual - stats.bancaInicial;
        const total = wins + losses;
        const tax = total > 0 ? ((wins / total) * 100).toFixed(1) : 0;
        document.getElementById('hist-content').innerHTML = `
            <div class="hist-line"><span>Banca Inicial:</span> <b>R$ ${stats.bancaInicial.toFixed(2)}</b></div>
            <div class="hist-line"><span>Lucro Atual:</span> <b style="color:${profit>=0?'var(--green)':'var(--red)'}">R$ ${profit.toFixed(2)}</b></div>
            <div class="hist-line"><span>Wins Direto:</span> <b style="color:var(--green)">${stats.winsDireto}</b></div>
            <div class="hist-line"><span>Gale 1 usado:</span> <b>${stats.gale1}</b></div>
            <div class="hist-line"><span>Gale 2 usado:</span> <b>${stats.gale2}</b></div>
            <div class="hist-line"><span>Assertividade:</span> <b>${tax}%</b></div>
            <div class="hist-line"><span>In√≠cio:</span> <b>${stats.startTime}</b></div>
        `;
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const profit = bancaAtual - stats.bancaInicial;
        doc.setFillColor(17, 21, 28);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(0, 162, 255);
        doc.setFontSize(22);
        doc.setFont("helvetica", "bold");
        doc.text("K.COM BRAIN„ÄΩÔ∏è", 105, 20, { align: "center" });
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        doc.text("RELAT√ìRIO DE PERFORMANCE OPERACIONAL", 105, 30, { align: "center" });
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.text(`Data: ${new Date().toLocaleDateString()} | In√≠cio: ${stats.startTime}`, 20, 50);
        doc.setDrawColor(200, 200, 200);
        doc.line(20, 55, 190, 55);
        doc.setFont("helvetica", "bold");
        doc.text("RESUMO FINANCEIRO", 20, 65);
        doc.setFont("helvetica", "normal");
        doc.text(`Banca Inicial: R$ ${stats.bancaInicial.toFixed(2)}`, 20, 75);
        doc.text(`Lucro/Preju√≠zo: R$ ${profit.toFixed(2)}`, 20, 85);
        doc.text(`Assertividade: ${((wins/(wins+losses||1))*100).toFixed(1)}%`, 20, 95);
        doc.setFont("helvetica", "bold");
        doc.text("ESTAT√çSTICAS DE ENTRADA", 110, 65);
        doc.setFont("helvetica", "normal");
        doc.text(`Wins Direto: ${stats.winsDireto}`, 110, 75);
        doc.text(`Wins em Gale 1: ${stats.gale1}`, 110, 85);
        doc.text(`Wins em Gale 2: ${stats.gale2}`, 110, 95);
        doc.text(`Loss Totais: ${losses}`, 110, 105);
        doc.setDrawColor(0, 162, 255);
        doc.setLineWidth(0.5);
        doc.line(20, 115, 190, 115);
        doc.setFont("helvetica", "bold");
        doc.text("HIST√ìRICO DE ENTRADAS DETALHADO", 20, 125);
        doc.setFontSize(9);
        doc.setFont("courier", "normal");
        let yPos = 135;
        stats.fullLog.forEach((item, index) => {
            if(yPos > 280) { doc.addPage(); yPos = 20; }
            const line = `${item.time} | ${item.asset.padEnd(20)} | Op: ${item.action.padEnd(5)} | Res: ${item.status}`;
            doc.text(line, 20, yPos);
            yPos += 7;
        });
        doc.save(`Relatorio_KCM_${new Date().getTime()}.pdf`);
    }

    const canvas = document.getElementById('chartCanvas');
    const ctx = canvas.getContext('2d');
    const priceTag = document.getElementById('price-tag');
    const timerTxt = document.getElementById('timer');
    const trendDisplay = document.getElementById('trend-info');
    const signalAlert = document.getElementById('signal-alert');
    const stopwatchTxt = document.getElementById('stopwatch');
    let swTime = 0, swInterval = null, swRunning = false;
    let resM15 = [], supM15 = [];
    let trendM15 = "LATERAL"; 
    let bBandsBuffer = [];
    function getEMA(list, period) { if (list.length < period) return 0; const k = 2 / (period + 1); let ema = list[0].close; for (let i = 1; i < list.length; i++) { ema = (list[i].close * k) + (ema * (1 - k)); } return ema; }
    function calculateBBands(list, period = 20, dev = 2) { if (list.length < period) return null; let results = []; for (let i = period; i <= list.length; i++) { const slice = list.slice(i - period, i); const avg = slice.reduce((a, b) => a + b.close, 0) / period; const sqDiff = slice.reduce((a, b) => a + Math.pow(b.close - avg, 2), 0); const stdDev = Math.sqrt(sqDiff / period); results.push({ mid: avg, upper: avg + (dev * stdDev), lower: avg - (dev * stdDev), index: i - 1 }); } return results; }
    function toggleStopwatch() { if(swRunning) { clearInterval(swInterval); swRunning = false; stopwatchTxt.style.color = 'var(--yellow)'; } else { swRunning = true; stopwatchTxt.style.color = 'var(--green)'; swInterval = setInterval(() => { swTime++; let m = Math.floor(swTime/60).toString().padStart(2,'0'); let s = (swTime%60).toString().padStart(2,'0'); stopwatchTxt.innerText = `${m}:${s}`; }, 1000); } }
    function resetStopwatch() { clearInterval(swInterval); swTime = 0; swRunning = false; stopwatchTxt.innerText = "00:00"; stopwatchTxt.style.color = 'var(--green)'; }
    let bancaAtual = 1000.00, payoutAtivo = 85, percentualUso = 1, valorApostaAtual = 0;
    let wins = 0, losses = 0, emGale = 0, sinalPendente = null, operacaoAtiva = null;
    let history = [], current = null, lastPrice = 0, socket = null;
    let spacing = 24, dragX = 0, dragY = 0, zoomY = 2;
    let lastX, lastY, isDragging = false;
    let resistances = [], supports = [], lastCandleGroup = -1;
    let fractals = [];
    let pulseOpacity = 1, pulseDir = -0.05;
    let initialDist = null;

    function analyzeCandlePatterns(list, idx) { 
        if(list.length < 21 || idx < 1) return null; 
        const last = list[idx]; 
        const prev = list[idx - 1]; 
        const body = Math.abs(last.close - last.open); 
        const totalSize = last.high - last.low;
        let avgTotalSize = 0;
        for(let i = idx-10; i < idx; i++) { avgTotalSize += (list[i].high - list[i].low); }
        avgTotalSize /= 10;
        if (totalSize < (avgTotalSize * 0.7)) return null; 
        if (body < (totalSize * 0.40) || body === 0) return null;
        let sma20 = 0;
        for(let i = idx-20; i <= idx; i++) sma20 += list[i].close;
        sma20 /= 21;
        const upperWick = last.high - Math.max(last.open, last.close); 
        const lowerWick = Math.min(last.open, last.close) - last.low; 
        const isLow = last.low <= Math.min(prev.low, list[idx-2]?.low || 999999); 
        const isHigh = last.high >= Math.max(prev.high, list[idx-2]?.high || 0); 
        if (lowerWick > body * 2 && upperWick < body * 0.5 && isLow && last.close > sma20) return { name: "MARTELO", dir: "CALL" }; 
        if (upperWick > body * 2 && lowerWick < body * 0.5 && isHigh && last.close < sma20) return { name: "ESTRELA", dir: "PUT" }; 
        if (last.close > last.open && prev.open > prev.close && last.close > prev.open && last.close > sma20) return { name: "ENGOLFO", dir: "CALL" }; 
        if (last.open > last.close && prev.close > prev.open && last.close < prev.open && last.close < sma20) return { name: "ENGOLFO", dir: "PUT" }; 
        return null; 
    }

    function showScreenMsg(txt, color) { signalAlert.innerText = txt; signalAlert.style.color = color; signalAlert.style.display = 'block'; setTimeout(() => { signalAlert.style.display = 'none'; }, 8000); }
    function detectTrend() { if(history.length < 20) return "EST√ÅVEL"; const sum = history.slice(-10).reduce((a, b) => a + (b.close > b.open ? 1 : -1), 0); let msg = sum > 2 ? "TEND√äNCIA: ALTA üìà" : (sum < -2 ? "TEND√äNCIA: BAIXA üìâ" : "MERCADO LATERALIZADO"); return msg + " | M15: " + (trendM15 === "UP" ? "ALTA" : "BAIXA"); }
    function updateFinanceUI() { document.getElementById('val-banca').innerText = `R$ ${bancaAtual.toFixed(2)}`; document.getElementById('val-payout').innerText = `${payoutAtivo}%`; document.getElementById('val-percent').innerText = `${percentualUso}%`; }
    function editFinance(tipo) { let n = prompt(`Novo valor para ${tipo}:`); if(n) { if(tipo==='banca') { bancaAtual = parseFloat(n); stats.bancaInicial = bancaAtual; } if(tipo==='payout') payoutAtivo = parseFloat(n); if(tipo==='percent') percentualUso = parseFloat(n); updateFinanceUI(); } }
    function calculateIndicators() { if(history.length < 10) return; const all = [...history, current]; fractals = []; for(let i = 2; i < all.length - 2; i++) { if(all[i].high > all[i-1].high && all[i].high > all[i-2].high && all[i].high > all[i+1].high && all[i].high > all[i+2].high) { fractals.push({ index: i, type: 'top', price: all[i].high }); } if(all[i].low < all[i-1].low && all[i].low < all[i-2].low && all[i].low < all[i+1].low && all[i].low < all[i+2].low) { fractals.push({ index: i, type: 'bottom', price: all[i].low }); } } bBandsBuffer = calculateBBands(all); }
    const LISTA_COMPLETA = [ { id: "NONE", nome: "‚ùå DESATIVAR SLOT" }, { id: "1HZ10V", nome: "üìà Volatility 10 (1s)" }, { id: "1HZ25V", nome: "üìà Volatility 25 (1s)" }, { id: "1HZ50V", nome: "üìà Volatility 50 (1s)" }, { id: "1HZ75V", nome: "üìà Volatility 75 (1s)" }, { id: "1HZ100V", nome: "üìà Volatility 100 (1s)" }, { id: "R_10", nome: "üìä Volatility 10" }, { id: "R_25", nome: "üìä Volatility 25" }, { id: "R_50", nome: "üìä Volatility 50" }, { id: "R_75", nome: "üìä Volatility 75" }, { id: "R_100", nome: "üìä Volatility 100" }, { id: "JD10", nome: "üöÄ Jump 10" }, { id: "JD25", nome: "üöÄ Jump 25" }, { id: "JD50", nome: "üöÄ Jump 50" }, { id: "JD75", nome: "üöÄ Jump 75" }, { id: "JD100", nome: "üöÄ Jump 100" }, { id: "BOOM300", nome: "üí• Boom 300" }, { id: "BOOM500", nome: "üí• Boom 500" }, { id: "BOOM1000", nome: "üí• Boom 1000" }, { id: "CRASH300", nome: "üìâ Crash 300" }, { id: "CRASH500", nome: "üìâ Crash 500" }, { id: "CRASH1000", nome: "üìâ Crash 1000" }, { id: "ST50", nome: "üé¢ Step Index" }, { id: "frxEURUSD", nome: "üí± EUR/USD" }, { id: "frxGBPUSD", nome: "üí± GBP/USD" }, { id: "frxUSDJPY", nome: "üí± USD/JPY" }, { id: "frxAUDUSD", nome: "üí± AUD/USD" }, { id: "frxUSDCAD", nome: "üí± USD/CAD" }, { id: "frxUSDCHF", nome: "üí± USD/CHF" }, { id: "frxEURGBP", nome: "üí± EUR/GBP" }, { id: "frxEURJPY", nome: "üí± EUR/JPY" }, { id: "frxXAUUSD", nome: "ü™ô OURO (XAU)" }, { id: "cryBTCUSD", nome: "‚Çø BITCOIN" } ];
    const menu = document.getElementById('menu'); LISTA_COMPLETA.forEach(ativo => { const div = document.createElement('div'); div.className = 'item'; div.innerHTML = ativo.nome; div.onclick = () => sel(ativo.id, ativo.nome); menu.appendChild(div); });
    function toggleMenu() { menu.classList.toggle('open'); }
    function sel(id, nome) { document.getElementById('asset-display').innerText = nome; stats.ativoAtual = nome; history = []; current = null; bBandsBuffer = []; toggleMenu(); connect(id); }
    function updateAnalisis() { if (history.length < 20) return; const recent = history.slice(-50); let topos = [], fundos = []; for(let i=2; i<recent.length-2; i++) { if(recent[i].high > recent[i-1].high && recent[i].high > recent[i+1].high) topos.push(recent[i].high); if(recent[i].low < recent[i-1].low && recent[i].low < recent[i+1].low) fundos.push(recent[i].low); } resistances = [...new Set(topos)].slice(-4); supports = [...new Set(fundos)].slice(-4); calculateIndicators(); trendDisplay.innerText = detectTrend(); }
    function connect(symbol) { if(socket) socket.close(); socket = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089'); socket.onopen = () => { socket.send(JSON.stringify({ ticks_history: symbol, end: "latest", count: 100, style: "candles", granularity: 60, subscribe: 1 })); socket.send(JSON.stringify({ ticks_history: symbol, end: "latest", count: 50, style: "candles", granularity: 900 })); }; socket.onmessage = (msg) => { const data = JSON.parse(msg.data); if(data.candles && !data.echo_req.subscribe) { const gran = data.echo_req.granularity; if(gran === 900) { const lastM15 = data.candles[data.candles.length-1]; supM15 = [lastM15.low]; resM15 = [lastM15.high]; trendM15 = lastM15.close > lastM15.open ? "UP" : "DOWN"; } } if(data.candles && data.echo_req.subscribe) { history = data.candles; current = history.pop(); updateAnalisis(); } if(data.ohlc) { lastPrice = parseFloat(data.ohlc.close); const now = new Date(); const curGroup = now.getMinutes() + now.getHours() * 60; if (lastCandleGroup !== -1 && curGroup !== lastCandleGroup) { if (operacaoAtiva) validarResultado(current); if (sinalPendente) { if(emGale === 1) { audioQuaQua.play(); falar("Gale 1"); } if(emGale === 2) { audioQuaQua.play(); falar("Gale 2"); } stats.totalEntradas++; valorApostaAtual = emGale === 0 ? (bancaAtual * (percentualUso / 100)) : valorApostaAtual * 2; bancaAtual -= valorApostaAtual; updateFinanceUI(); operacaoAtiva = { dir: sinalPendente.dir, precoEntrada: lastPrice, valorRiscado: valorApostaAtual, indexEntrada: history.length, galeNivel: emGale }; sinalPendente = null; signalAlert.style.display = 'none'; } if (current && !operacaoAtiva) { history.push({...current}); const pattern = analyzeCandlePatterns(history, history.length - 1); if(pattern) { const ema20 = getEMA(history, 20); let trendOk = (pattern.dir === "CALL" && lastPrice > ema20 && trendM15 === "UP") || (pattern.dir === "PUT" && lastPrice < ema20 && trendM15 === "DOWN"); if(trendOk) { audioSirene.play(); sinalPendente = pattern; document.getElementById('gale-txt').innerText = "GATILHO: " + pattern.name; showScreenMsg(pattern.dir + "!", pattern.dir === "CALL" ? "var(--green)" : "var(--red)"); } } } else if (current) { history.push({...current}); if(operacaoAtiva) operacaoAtiva.indexEntrada = history.length; } current = { time: data.ohlc.open_time, open: lastPrice, high: lastPrice, low: lastPrice, close: lastPrice }; updateAnalisis(); } else if(current) { current.close = lastPrice; current.high = Math.max(current.high, lastPrice); current.low = Math.min(current.low, lastPrice); } lastCandleGroup = curGroup; let secRest = 59 - now.getSeconds(); timerTxt.innerText = `00:${secRest.toString().padStart(2, '0')}`; } }; }
    function validarResultado(v) { 
        const win = (operacaoAtiva.dir === 'CALL' && v.close > operacaoAtiva.precoEntrada) || (operacaoAtiva.dir === 'PUT' && v.close < operacaoAtiva.precoEntrada); 
        const profit = operacaoAtiva.valorRiscado * (payoutAtivo/100);
        if(win) { 
            audioWin.play(); wins++; bancaAtual += (operacaoAtiva.valorRiscado * (1 + payoutAtivo/100)); 
            stats.ativosLucro[stats.ativoAtual] = (stats.ativosLucro[stats.ativoAtual] || 0) + profit;
            let statusTxt = operacaoAtiva.galeNivel === 0 ? "GREEN" : "G" + operacaoAtiva.galeNivel + " GREEN";
            if(operacaoAtiva.galeNivel === 0) stats.winsDireto++; else if(operacaoAtiva.galeNivel === 1) stats.gale1++; else stats.gale2++;
            addDetailedLog(operacaoAtiva.dir, statusTxt, "var(--green)");
            emGale = 0; operacaoAtiva = null; document.getElementById('gale-txt').innerText = "WIN ‚úÖ"; 
        } else if(emGale < 2) { 
            emGale++; sinalPendente = { dir: operacaoAtiva.dir, name: "GALE " + emGale }; 
        } else { 
            audioQuaQua.play(); losses++; 
            addDetailedLog(operacaoAtiva.dir, "LOSS", "var(--red)");
            emGale = 0; operacaoAtiva = null; document.getElementById('gale-txt').innerText = "LOSS ‚ùå"; 
        } 
        updateFinanceUI(); document.getElementById('win-c').innerText = wins; document.getElementById('loss-c').innerText = losses; 
    }
    
    // CORRE√á√ÉO DO ZOOM E ARRASTE
    function draw() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        if(!current) { requestAnimationFrame(draw); return; }
        pulseOpacity += pulseDir; if(pulseOpacity <= 0.3 || pulseOpacity >= 1) pulseDir *= -1;
        const all = [...history, current];
        const prices = all.flatMap(c => [c.high, c.low]);
        const maxP = Math.max(...prices), minP = Math.min(...prices), range = (maxP - minP) || 0.0001;
        const scaleY = (canvas.height * 0.7 / range) * zoomY, centerY = canvas.height / 2 + dragY, midP = (maxP + minP) / 2, offX = (canvas.width - 150) - (all.length * spacing) + dragX;
        
        if(all.length >= 200) { ctx.beginPath(); ctx.strokeStyle = "var(--yellow)"; ctx.lineWidth = 2.5; for(let i = 200; i < all.length; i++) { const emaVal = getEMA(all.slice(0, i+1), 200); const x = offX + (i * spacing); const y = centerY + (midP - emaVal) * scaleY; if(i === 200) ctx.moveTo(x, y); else ctx.lineTo(x, y); } ctx.stroke(); }
        if(bBandsBuffer.length > 1) { ctx.beginPath(); ctx.fillStyle = "rgba(0, 162, 255, 0.02)"; for(let i = 0; i < bBandsBuffer.length; i++) { let x = offX + (bBandsBuffer[i].index * spacing); let y = centerY + (midP - bBandsBuffer[i].upper) * scaleY; i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); } for(let i = bBandsBuffer.length - 1; i >= 0; i--) { let x = offX + (bBandsBuffer[i].index * spacing); let y = centerY + (midP - bBandsBuffer[i].lower) * scaleY; ctx.lineTo(x, y); } ctx.closePath(); ctx.fill(); }
        
        all.forEach((c, i) => {
            const x = offX + (i * spacing), yO = centerY + (midP - c.open) * scaleY, yC = centerY + (midP - c.close) * scaleY, yH = centerY + (midP - c.high) * scaleY, yL = centerY + (midP - c.low) * scaleY;
            const isGatilho = (sinalPendente && i === all.length - 1); if(isGatilho) ctx.globalAlpha = pulseOpacity; ctx.strokeStyle = c.close >= c.open ? "#00ff88" : "#ff3355"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(x, yH); ctx.lineTo(x, yL); ctx.stroke(); ctx.fillStyle = ctx.strokeStyle; ctx.fillRect(x - (spacing*0.7)/2, Math.min(yO, yC), spacing*0.7, Math.max(2, Math.abs(yO - yC))); ctx.globalAlpha = 1.0;
        });
        const currentY = centerY + (midP - lastPrice) * scaleY; priceTag.style.top = (currentY - 15) + "px"; priceTag.style.background = lastPrice >= current.open ? "#00ff88" : "#ff3355"; priceTag.innerText = lastPrice.toFixed(midP > 10 ? 2 : 5); requestAnimationFrame(draw);
    }
    
    // EVENTOS DE INTERA√á√ÉO CORRIGIDOS
    canvas.addEventListener('mousedown', e => { isDragging = true; lastX = e.clientX; lastY = e.clientY; }); 
    window.addEventListener('mousemove', e => { if(isDragging) { dragX += e.clientX - lastX; dragY += e.clientY - lastY; lastX = e.clientX; lastY = e.clientY; } }); 
    window.addEventListener('mouseup', () => isDragging = false); 
    canvas.addEventListener('wheel', e => { 
        e.preventDefault(); 
        const zoomSpeed = 0.1;
        if(e.deltaY < 0) { // Zoom In
            spacing *= 1.1;
            zoomY *= 1.1;
        } else { // Zoom Out
            spacing *= 0.9;
            zoomY *= 0.9;
        }
        spacing = Math.min(Math.max(spacing, 2), 200);
        zoomY = Math.min(Math.max(zoomY, 0.05), 50);
    }, { passive: false });

    // SUPORTE PARA TOUCH (CELULAR)
    canvas.addEventListener('touchstart', e => { 
        if(e.touches.length === 1) {
            isDragging = true; lastX = e.touches[0].clientX; lastY = e.touches[0].clientY;
        } else if(e.touches.length === 2) {
            initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        }
    });
    canvas.addEventListener('touchmove', e => {
        if(isDragging && e.touches.length === 1) {
            dragX += e.touches[0].clientX - lastX; dragY += e.touches[0].clientY - lastY;
            lastX = e.touches[0].clientX; lastY = e.touches[0].clientY;
        } else if(e.touches.length === 2) {
            const currentDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            const delta = currentDist / initialDist;
            spacing = Math.min(Math.max(spacing * delta, 2), 200);
            zoomY = Math.min(Math.max(zoomY * delta, 0.05), 50);
            initialDist = currentDist;
        }
    }, { passive: false });
    canvas.addEventListener('touchend', () => { isDragging = false; initialDist = null; });

    connect('R_100'); draw(); updateFinanceUI();
</script>
</body>
</html>
